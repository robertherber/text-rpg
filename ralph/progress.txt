# Ralph Progress Log
# Feature: Dialog & Map UI Improvements
# Branch: ralph/dialog-map-improvements
# Started: 2026-02-14

## Codebase Patterns
- Pre-existing type errors exist in index.ts, App.tsx, gameEngine.ts, imageService.ts - don't need to fix these for new features
- GPT prompts are in src/world/gptService.ts
- Frontend components in src/frontend/ with worldStyles.css for styling
- Map rendering uses HTML Canvas in MapPanel.tsx
- World system uses /api/world/* endpoints with worldState.locations, old game system uses /api/game/* with static gameData
- Image generation: use generateWorldImage() for dynamic world locations (includes NPC-aware hash caching)

---

## 2026-02-14 - US-001
- What was implemented: De-emphasized narrator text styling with italic gray (#6b7280) and kept NPC dialog in normal weight with standard text color
- Files changed:
  - src/frontend/StoryPanel.tsx - Added parseNarrativeText function to segment narrator vs dialog, added NarrativeText component
  - src/frontend/worldStyles.css - Added .narrator-text, .dialog-speaker, .dialog-text styles
- **Learnings for future iterations:**
  - Narrative messages contain both narrator descriptions and NPC dialog (quoted text with optional speaker prefix)
  - Dialog pattern uses Name: "text" format or standalone "text" quotes
  - StoryPanel uses a "type" field to distinguish narrative/action/system messages

---

## 2026-02-14 - US-002
- What was implemented: Updated all GPT prompts to use immersive terminology ("adventurer", "traveler", "hero") instead of "player"
- Files changed:
  - src/world/gptService.ts - Updated NARRATOR_PERSONALITY, conversation system prompt, action resolution system prompt, rejection prompt, suggested actions prompt, location generation, world simulation, travel narratives, crafting/building prompts, and character creation prompts
- **Learnings for future iterations:**
  - The NARRATOR_PERSONALITY constant is prepended to all system prompts via `callGPT()`, so adding global instructions there affects all GPT outputs
  - State change type names like `move_player`, `player_damage` are code identifiers and should NOT be changed - only narrative text should use "adventurer"
  - Many prompts had "player" references that needed updating: action resolution, conversation, rejection, suggestions, travel, crafting, building, character creation, world simulation

---

## 2026-02-14 - US-003
- What was implemented: Added explicit instructions to prevent narrator from repeating NPC dialog
- Files changed:
  - src/world/gptService.ts - Added "IMPORTANT DIALOG RULES" section to NARRATOR_PERSONALITY, strengthened action resolution RULES with CRITICAL DIALOG RULE including WRONG/CORRECT examples, updated conversation RULES to emphasize dialog appears only in npcResponse
- **Learnings for future iterations:**
  - The NARRATOR_PERSONALITY constant affects ALL prompts globally, so it's the best place for universal rules
  - Using explicit WRONG/CORRECT examples in prompts helps GPT understand the desired behavior better than just negative instructions
  - The conversation system uses separate fields: npcResponse for dialog, narratorFrame for description - reinforcing this separation in rules prevents redundancy

---

## 2026-02-14 - US-004
- What was implemented: Added brevity rules to enforce concise dialog and narration lengths
- Files changed:
  - src/world/gptService.ts - Added "BREVITY RULES" section to NARRATOR_PERSONALITY, added brevity rule to action resolution RULES, updated conversation RULES with specific length limits, updated RESPONSE STRUCTURE comments with max sentence counts, updated schema descriptions for narratives (ACTION_RESULT_SCHEMA, TRAVEL_ENCOUNTER_SCHEMA, crafting/building schemas)
- **Learnings for future iterations:**
  - Length guidance should be specified in multiple places: global NARRATOR_PERSONALITY for universal effect, specific RULES sections for context-specific prompts, and JSON schema descriptions for structured outputs
  - Schema descriptions also influence GPT output - updating "description" fields in JSON schemas with length guidance helps reinforce brevity constraints
  - The key areas for narrative length are: action narratives (2-3 sentences), NPC dialog (1-2 sentences), narrator frames (1 sentence)

---

## 2026-02-14 - US-005
- What was implemented: Added dialog response suggestions to handleConversation - GPT now generates 3 suggested responses (2 contextual + 1 generic) for the adventurer
- Files changed:
  - src/world/gptService.ts - Added SuggestedResponseType and SuggestedResponse exports, updated CONVERSATION_RESPONSE_SCHEMA with suggestedResponses array schema, updated ConversationResponse and ConversationResult interfaces, added SUGGESTED RESPONSES section to conversation system prompt, updated return to include suggestedResponses with unique IDs
- **Learnings for future iterations:**
  - Each suggestion has {id, text, type} where id is generated with Date.now() + index for uniqueness
  - The type is either "contextual" (specific to conversation) or "generic" (fallback like farewell/rumors)
  - Tone brackets format: "[Tone] Dialog text" - tones include Friendly, Curious, Suspicious, Aggressive, Grateful, Nervous, Confident, Playful, Serious, Dismissive
  - US-006 will need to import SuggestedResponse and SuggestedResponseType from gptService.ts for the UI

---

## 2026-02-14 - US-006
- What was implemented: Display dialog suggestions as clickable buttons in conversation UI
- Files changed:
  - index.ts - Added suggestedResponses to /api/world/talk response
  - src/frontend/WorldApp.tsx - Added SuggestedResponse interface, extended ConversationState to include suggestedResponses, updated handleConversationMessage to store suggestions
  - src/frontend/ActionPanel.tsx - Added SuggestedResponse interface and updated ConversationMode, added handleSuggestedResponseClick handler, rendered suggestion buttons below input
  - src/frontend/worldStyles.css - Added .suggested-responses container, .suggested-response button styles with contextual/generic variants
- **Learnings for future iterations:**
  - ConversationState passes suggestions through the conversationMode prop to ActionPanel
  - Clicking a suggestion extracts the dialog text (removing the [Tone] prefix) and sends it via onConversationMessage
  - Suggestions update after each NPC response (stored in conversationState)
  - The suggested-response buttons use visual distinction: contextual has green left border, generic has gray

---

## 2026-02-14 - US-007
- What was implemented: Added GPT retry logic with exponential backoff for JSON parse failures
- Files changed:
  - src/world/gptService.ts - Added MAX_RETRIES (2) and RETRY_DELAYS ([500, 1500]) constants, added sleep() helper, refactored GPT call into makeGPTCall() helper, implemented retry loop in callGPT() for JSON responses with logging and user-friendly error messages
- **Learnings for future iterations:**
  - The callGPT function handles both JSON and non-JSON responses - retry logic only applies to JSON parsing failures
  - API-level errors (network, auth, model not found) are not retried - only JSON parse errors
  - The makeGPTCall helper reduces duplication for the primary/fallback model logic
  - Error messages should be user-friendly since they may be displayed in the UI (US-008 will handle this)

---

## 2026-02-14 - US-008
- What was implemented: Added error handling UI with retry capability for failed API requests
- Files changed:
  - src/frontend/WorldApp.tsx - Added LastAction union type to track last action for retry, added actionError and lastAction state, added handleRetry function that re-executes based on action type, updated all action handlers (handleAction, handleFreeformSubmit, handleConversationMessage, handleUseItem) to track lastAction and set actionError on catch
  - src/frontend/StoryPanel.tsx - Added actionError and onRetry props, displays error message with "Try again" button at bottom of story panel
  - src/frontend/worldStyles.css - Added .story-message.error, .error-text, and .error-retry-button styles with red theme
- **Learnings for future iterations:**
  - Error handling uses a union type (LastAction) to track what kind of action failed so it can be retried correctly
  - StoryPanel is the ideal place to show inline errors since it maintains scroll context with messages
  - Error state is cleared on success OR when starting a new action, so errors don't persist unnecessarily
  - The retry button re-calls the same handler function, so all retry logic is centralized in handleRetry

---

## 2026-02-14 - US-009
- What was implemented: Added thematic loading indicators with pulsing animation and random text variations
- Files changed:
  - src/frontend/StoryPanel.tsx - Added LOADING_MESSAGES array with 8 thematic variations, added LoadingIndicator component using useState for random message selection, added isLoading prop, renders indicator inline after messages
  - src/frontend/WorldApp.tsx - Added isLoading={isProcessing} prop to StoryPanel
  - src/frontend/worldStyles.css - Added .loading-indicator and .loading-text styles with loading-pulse keyframe animation (2s ease-in-out infinite, 0.4-1.0 opacity)
- **Learnings for future iterations:**
  - useState with initializer function (() => getRandomLoadingMessage()) ensures the random message is selected once on mount, not on every render
  - The isProcessing state in WorldApp is already used by ActionPanel to disable buttons, so reusing it for loading indicator is consistent
  - The loading indicator auto-scrolls by including isLoading in the useEffect dependency array for scrollTop

---

## 2026-02-14 - US-010
- What was implemented: Fixed image loading by creating a new world image endpoint that uses dynamic worldState.locations
- Files changed:
  - index.ts - Added /api/world/image/:id endpoint that looks up locations in worldState.locations and uses generateWorldImage() for NPC-aware image generation with proper caching
  - src/frontend/ImagePanel.tsx - Updated to fetch from /api/world/image/:id instead of /api/game/image/:id
- **Learnings for future iterations:**
  - The old /api/game/image/:id endpoint used getLocation() from gameEngine.ts which only looks up static locations in gameData.ts
  - Dynamic world locations are stored in worldState.locations, not the static gameData
  - The generateWorldImage() function from imageService.ts properly handles NPC-aware image generation with state hash caching
  - Always check whether an endpoint uses worldState (dynamic) vs gameData (static) when debugging world system issues

---

## 2026-02-14 - US-011
- What was implemented: Added enhanced image loading states with parchment placeholder, error handling with retry, and graceful fallbacks
- Files changed:
  - src/frontend/ImagePanel.tsx - Added parchment-style loading state with thematic messages ("Revealing...", "The scene unfolds...", etc.), error state with retry button, graceful fallback placeholder with terrain icons, and onError handler for broken image URLs
  - src/frontend/worldStyles.css - Added CSS for parchment-loading, parchment-placeholder, image-error state, loading animations (quill-pulse, reveal-text-fade), and terrain icons styling
- **Learnings for future iterations:**
  - The ImagePanel already had isLoading state - enhanced it rather than replacing
  - useCallback for loadImage allows retry functionality to call the same loading logic
  - onError handler on <img> catches broken image URLs and shows error state
  - Parchment texture uses multiple layered linear-gradients for aged paper effect
  - getTerrainIcon helper maps terrain types to emoji icons for placeholder display

---

