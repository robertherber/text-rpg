# Ralph Progress Log
# Feature: Open World Generation
# Branch: ralph/open-world-generation
# Started: 2026-02-14

## Codebase Patterns
- Pre-existing type errors exist in index.ts, App.tsx, gameEngine.ts, imageService.ts - don't need to fix these for new features
- Use `seedId(prefix, name)` helper to create consistent IDs for seed content
- Location coordinates use (x, y) grid with village at (0, 0)
- All seed content should have `isCanonical: true` flag

---

## 2026-02-14 - US-002
- What was implemented: Created seed world data with Millbrook village
- Files changed:
  - src/world/seedWorld.ts (created)
- **Learnings for future iterations:**
  - The codebase has pre-existing type errors that should be ignored when running `tsc --noEmit`
  - Can test individual files with `bun run tsc --noEmit <file>` to verify new code
  - Use `bun -e "..."` for quick import/functionality tests
  - Seed locations: village square (0,0), tavern (0,1), blacksmith (1,0), elder house (-1,0), gate (0,-1)
---

## 2026-02-14 - US-003
- What was implemented: Initialize world state on server startup
- Files changed:
  - index.ts (modified - added world state initialization)
- **Learnings for future iterations:**
  - Bun supports top-level await, so `await initializeWorldState()` works before `Bun.serve()`
  - Module-level `worldState` variable is exported implicitly and accessible for future API endpoints
  - Server port 3000 may be in use during testing - can still verify initialization by checking console output
  - World state file persists at `world-state.json` in project root
---

## 2026-02-14 - US-004
- What was implemented: Created 4 seed NPCs with soul instructions
- Files changed:
  - src/world/seedWorld.ts (modified - added NPCs)
- **Learnings for future iterations:**
  - NPCs created: Marta (barkeep), Grimjaw (blacksmith), Elder Bramwell, Pip (stablehand)
  - Each NPC has a detailed `soulInstruction` paragraph covering: background, goals, personality, speech patterns, gullibility
  - NPCs are placed at locations via `locations[x].presentNpcIds` array
  - Player starts with knowledge of NPCs they can see (Pip in village square)
  - NPCs can have items in their `inventory` array (e.g., Grimjaw has a dagger for sale)
  - Attitude scale: -100 to 100 (70 = very friendly, 10 = neutral/reserved, 50 = friendly)
---

## 2026-02-14 - US-005
- What was implemented: Created OpenAI client wrapper for GPT calls
- Files changed:
  - src/world/gptService.ts (created)
- **Learnings for future iterations:**
  - OpenAI package is already installed in package.json
  - `callGPT<T>` function is generic, allowing typed JSON responses when jsonSchema is provided
  - Model fallback: tries gpt-5-mini first, falls back to gpt-4o-mini if not available
  - Narrator personality is appended to every system prompt automatically
  - Use `response_format: { type: "json_schema", json_schema: { name, strict, schema } }` for structured output
  - `callGPTNarrative` is a convenience wrapper for simple text responses
  - OPENAI_API_KEY environment variable is read automatically by Bun from .env
---

## 2026-02-14 - US-006
- What was implemented: Created GPT context builder for action resolution
- Files changed:
  - src/world/gptService.ts (modified - added buildActionContext function)
- **Learnings for future iterations:**
  - `buildActionContext(worldState)` builds a structured text context for GPT prompts
  - Context includes: current location details, present NPCs with attitude descriptions, last 5 events, player stats, inventory (max 10 items shown), and knowledge summary
  - NPCs are filtered to only show those present at current location and alive
  - Attitude is described qualitatively: very friendly (>=70), friendly (>=40), neutral (>=10), wary (>=-30), hostile (<-30)
  - Use `bun -e "..."` for quick runtime validation of new functions
  - Context is kept concise to stay under 4000 tokens - inventories and knowledge lists are truncated
---

## 2026-02-14 - US-007
- What was implemented: Created action resolution function for GPT to resolve player actions
- Files changed:
  - src/world/gptService.ts (modified - added resolveAction function and ACTION_RESULT_SCHEMA)
- **Learnings for future iterations:**
  - `resolveAction(worldState, action)` is the main entry point for resolving player actions via GPT
  - Use JSON schema with `response_format` for structured GPT responses that parse into ActionResult
  - Schema must have `additionalProperties: false` for strict mode and all required fields specified
  - The system prompt includes comprehensive rules for what GPT should return: state change types, suggested action types
  - State change types are documented in the prompt so GPT knows what format to return
  - Suggested action IDs should be simple like "action_1", "action_2" for uniqueness
---

## 2026-02-14 - US-008
- What was implemented: Created state change applier to apply StateChange arrays to WorldState immutably
- Files changed:
  - src/world/stateManager.ts (created)
- **Learnings for future iterations:**
  - `applyStateChanges(state, changes)` iterates through changes and applies them sequentially
  - Each handler returns a new WorldState object (immutable updates)
  - move_player also updates the destination location's `lastVisitedAtAction`
  - add_item/remove_item support optional `toLocation`/`fromLocation` and `toNpc`/`fromNpc` for flexible item movement
  - add_knowledge supports both knowledge types (locations, npcs, lore, recipes) and skills
  - Unknown state change types log a warning but don't crash - allows incremental handler additions
  - Gold and health are clamped (gold >= 0, health between 0 and maxHealth)
---

## 2026-02-14 - US-009
- What was implemented: Added NPC state change handlers for NPC-related game state modifications
- Files changed:
  - src/world/stateManager.ts (modified - added 6 new handlers)
- **Learnings for future iterations:**
  - `move_npc`: Updates NPC's currentLocationId AND syncs location.presentNpcIds arrays (removes from old, adds to new)
  - `update_npc_attitude`: Supports both relative `change` and absolute `attitude` values, clamps to -100 to 100
  - `npc_death`: Sets isAlive=false, health=0, deathDescription; also removes from player.companionIds if companion
  - `add_companion`: Sets NPC.isCompanion=true and adds to player.companionIds (idempotent - won't duplicate)
  - `remove_companion`: Sets NPC.isCompanion=false and removes from player.companionIds
  - `create_npc`: Creates complete NPC with defaults for missing fields, auto-generates ID, adds to location.presentNpcIds
  - Dynamically created NPCs get `isCanonical: false` to distinguish from seed content
  - NPC IDs follow pattern `npc_{name}_{role}` (e.g., `npc_marta_barkeep`, `npc_pip_stablehand`)
---

## 2026-02-14 - US-010
- What was implemented: Added location and structure state change handlers
- Files changed:
  - src/world/stateManager.ts (modified - added 4 new handlers + helper function)
- **Learnings for future iterations:**
  - `create_location`: Accepts optional `direction` and `fromLocationId` to auto-calculate coordinates
  - Direction mapping: north=(0,1), south=(0,-1), east=(1,0), west=(-1,0), and diagonals combine these
  - `calculateCoordinatesFromDirection` helper function handles all 8 cardinal/ordinal directions
  - `update_location`: Prevents changing `id` and `coordinates` for safety - use create_location for new locations
  - `create_structure`: Defaults to player's current location if `locationId` not provided
  - `destroy_structure`: Also defaults to current location, validates structure exists before removal
  - Dynamically created locations get `isCanonical: false` like NPCs
  - Structure types: "camp", "shelter", "house", "fort", "trap", "marker", "grave"
  - `builtAtAction` defaults to current `state.actionCounter` when not provided
---

## 2026-02-14 - US-011
- What was implemented: Created suggested actions generator for GPT to produce contextual action options
- Files changed:
  - src/world/gptService.ts (modified - added generateSuggestedActions function and SUGGESTED_ACTIONS_SCHEMA)
- **Learnings for future iterations:**
  - `generateSuggestedActions(worldState)` returns Promise<SuggestedAction[]> using GPT with JSON schema
  - System prompt instructs GPT to include: movement options ("step carefully" for unexplored, "travel to" for known), NPC talk options, contextual examine/use/interact actions
  - Present NPCs are passed with their IDs so GPT can set targetNpcId correctly
  - Known locations are filtered from player.knowledge.locations and mapped to actual location objects for travel suggestions
  - Use `--skipLibCheck` when running tsc to avoid node_modules type errors
  - JSON schema wraps actions in an object `{ actions: SuggestedAction[] }` for strict mode compatibility
---

## 2026-02-14 - US-012
- What was implemented: Created GET /api/world/state API endpoint for world state retrieval
- Files changed:
  - index.ts (modified - added /api/world/state endpoint and generateSuggestedActions import)
- **Learnings for future iterations:**
  - Use type predicate `(npc): npc is NonNullable<typeof npc> =>` in filter() to narrow undefined types
  - Endpoint returns: currentLocation (with items, structures), presentNpcs (filtered & mapped), playerStats, suggestedActions
  - Pre-existing type errors in index.ts are from `req.json()` returning `unknown` - these are ignored per Codebase Patterns
  - Open World API endpoints section added with comment separator `// ===== Open World API Endpoints =====`
---

## 2026-02-14 - US-013
- What was implemented: Created POST /api/world/action API endpoint for suggested action selection
- Files changed:
  - index.ts (modified - added /api/world/action endpoint, resolveAction and applyStateChanges imports, lastSuggestedActions module variable)
- **Learnings for future iterations:**
  - Module-level `lastSuggestedActions` stores suggested actions from GET /api/world/state and POST /api/world/action for ID lookup
  - Use `as { actionId?: string }` type assertion for `req.json()` to handle pre-existing unknown type issues
  - Endpoint flow: find action by ID ‚Üí resolveAction ‚Üí applyStateChanges ‚Üí increment actionCounter ‚Üí saveWorldState ‚Üí return
  - `actionResult.suggestedActions` from resolveAction replaces the lastSuggestedActions for chained action selections
  - Returns: narrative, suggestedActions, initiatesCombat, revealsFlashback
---

## 2026-02-14 - US-014
- What was implemented: Created POST /api/world/freeform API endpoint for free-form text input
- Files changed:
  - index.ts (modified - added /api/world/freeform endpoint)
- **Learnings for future iterations:**
  - `/api/world/freeform` is nearly identical to `/api/world/action` but takes `{ text: string }` instead of `{ actionId: string }`
  - Text is trimmed before passing to resolveAction to handle whitespace
  - Same flow: resolveAction ‚Üí applyStateChanges ‚Üí increment actionCounter ‚Üí saveWorldState ‚Üí return
  - Validates text is non-empty string before processing
  - Also stores resulting suggestedActions in lastSuggestedActions for subsequent action ID lookups
---

## 2026-02-14 - US-015
- What was implemented: Added validateKnowledge function for player knowledge tracking
- Files changed:
  - src/world/stateManager.ts (modified - added validateKnowledge function)
- **Learnings for future iterations:**
  - `validateKnowledge(worldState, reference)` checks if player knows about a location/NPC/item
  - Function checks: knowledge.locations (ID and name), knowledge.npcs (ID and name), knowledge.lore, knowledge.recipes, knowledge.skills
  - Also checks: player inventory items, NPCs present at current location, items at current location, structures at current location, companions
  - References are normalized with `.toLowerCase().trim()` for case-insensitive matching
  - Uses `.includes()` for partial matching on names (e.g., "Millbrook" matches "Millbrook Village Square")
  - Player starting knowledge already set up in seedWorld.ts with all village locations, Pip (visible NPC), and basic lore
---

## 2026-02-14 - US-016
- What was implemented: Added knowledge validation to free-form input with playful narrator rejections
- Files changed:
  - index.ts (modified - added knowledge validation to /api/world/freeform endpoint)
  - src/world/gptService.ts (modified - added extractReferences and generateNarratorRejection functions)
- **Learnings for future iterations:**
  - `extractReferences(text)` uses heuristics to find entity references: capitalized words, quoted text, phrases after keywords like "go to", "talk to"
  - Common words are filtered out (directions, articles, pronouns) to avoid false positives
  - `generateNarratorRejection(unknownRefs, originalText)` uses GPT to create chaotic trickster rejection messages
  - Endpoint returns `knowledgeRejection: true` and `unknownReferences: []` array when rejecting
  - New suggested actions are generated even on rejection so player has valid options
  - Reference extraction doesn't catch generic words like "tavern" - player must use proper names like "The Rusty Tankard"
---

## 2026-02-14 - US-017
- What was implemented: Created dynamic location generator for discovering new areas
- Files changed:
  - src/world/gptService.ts (modified - added generateLocation function, GENERATED_LOCATION_SCHEMA, GeneratedLocationData interface)
- **Learnings for future iterations:**
  - `generateLocation(worldState, direction, fromLocationId)` generates new locations via GPT when player explores unknown areas
  - Function calculates coordinates using `calculateCoordinatesFromDirection()` (same logic as stateManager.ts)
  - Checks if location already exists at target coordinates - returns existing if found
  - Context includes: departure point details, nearby terrains, nearby location names, average danger level
  - GPT generates: name, description, imagePrompt, terrain, dangerLevel, features, possibleEncounters
  - Generated locations get `isCanonical: false` and empty arrays for presentNpcIds, items, structures, notes
  - Danger level is clamped to 0-10 range
  - Location ID format: `loc_{direction}_{timestamp}_{randomSuffix}`
  - Geographic coherence: prompts GPT to consider nearby terrain types for natural transitions
---

## 2026-02-14 - US-018
- What was implemented: Created dynamic NPC generator for spawning new NPCs
- Files changed:
  - src/world/gptService.ts (modified - added generateNPC function, GENERATED_NPC_SCHEMA, GeneratedNPCData interface)
- **Learnings for future iterations:**
  - `generateNPC(worldState, context, locationId?)` generates new NPCs via GPT with comprehensive character data
  - The `context` parameter describes why/where the NPC is needed (e.g., "a mysterious traveler at the tavern")
  - Location defaults to player's current location if not specified
  - `soulInstruction` is the most important field - must be a coherent paragraph (4-6 sentences) covering: background, goals, personality, speech patterns, trust/gullibility
  - NPC ID format: `npc_{name_with_underscores}_{timestamp_base36}`
  - Generated NPCs include: knowledge (nearby locations/lore), inventory, stats, potential quest hooks
  - Use type predicate `(npc): npc is NPC =>` in filter() to narrow possibly-undefined types
  - Inventory items get auto-generated IDs: `item_{npcId}_{index}`
  - Attitude clamped to -100 to 100 range
  - Generated NPCs get `isCanonical: false`, `isCompanion: false`, `isAlive: true`
  - `homeLocationId` defaults to where they're generated
---

## 2026-02-14 - US-019
- What was implemented: Created conversation system with memory for extended NPC dialogues
- Files changed:
  - src/world/gptService.ts (modified - added handleConversation function, CONVERSATION_RESPONSE_SCHEMA, ConversationResponse/ConversationResult interfaces)
- **Learnings for future iterations:**
  - `handleConversation(worldState, npcId, playerMessage)` returns ConversationResult with narrative, npcResponse, attitudeChange, newKnowledge, conversationSummary, suggestsEndConversation
  - Context builds from: NPC soulInstruction (full paragraph), last 5 conversationHistory entries, NPC knowledge, current attitude, location context
  - Past conversations show "actions ago" for time context (e.g., "[12 actions ago] Discussed the missing merchant")
  - NPC's `playerNameKnown` field tracks what name the player introduced themselves as
  - Attitude descriptions: very friendly (>=70), friendly (>=40), neutral (>=10), wary (>=-30), hostile (<-30)
  - Response includes `narratorFrame` for chaotic trickster commentary before/after NPC speech
  - Attitude changes clamped to ¬±20 range to prevent extreme swings from single exchanges
  - Animals (`isAnimal: true`) communicate through actions/sounds, not speech
  - The caller must handle storing the conversationSummary to NPC.conversationHistory and updating NPC.attitude
  - ConversationSummary type imported from types.ts for completeness
---

## 2026-02-14 - US-020
- What was implemented: Added POST /api/world/talk endpoint for NPC conversations with memory
- Files changed:
  - index.ts (modified - added /api/world/talk endpoint and handleConversation import)
- **Learnings for future iterations:**
  - `/api/world/talk` accepts `{ npcId: string, message: string }` in body
  - Endpoint validates: NPC exists, NPC is alive, NPC is at current location
  - Conversation updates are applied immediately after handleConversation returns:
    - NPC conversationHistory gets new entry with actionNumber, summary, playerAsked, npcRevealed
    - NPC attitude is updated (clamped to -100 to 100)
    - Player knowledge.lore is extended with newKnowledge (deduplicated)
  - Action counter incremented after each conversation exchange
  - Returns: narrative, npcResponse, npcName, attitudeChange, newAttitude, suggestsEndConversation, newKnowledge
  - Error handling: wraps handleConversation in try/catch to return friendly error messages
---

## 2026-02-14 - US-021
- What was implemented: Created world simulation on location entry
- Files changed:
  - src/world/gptService.ts (modified - added simulateLocationChanges function, LOCATION_SIMULATION_SCHEMA, LocationSimulationResult interface)
- **Learnings for future iterations:**
  - `simulateLocationChanges(worldState, locationId)` simulates changes when player returns to a location
  - Uses `lastVisitedAtAction` to calculate actions elapsed - if 0 or negative, no simulation needed
  - Change probability formula: `Math.min(0.9, 0.1 + (actionsElapsed * 0.04))` - 50% at 10 actions, 90% at 50 actions
  - NPCs can move between adjacent locations based on their soul instructions
  - Companions (`isCompanion: true`) are explicitly excluded from moving independently
  - Returns: hasChanges, narrative, npcMovements, npcArrivals, environmentalChanges, newItems, removedItemIds
  - NPC movements include: npcId, reason (why they moved), destinationLocationId
  - NPC arrivals include: npcId, reason (why they arrived), fromLocationId
  - GPT receives truncated soul instructions (first 200 chars) to keep context manageable
  - The caller must apply the state changes (npcMovements, npcArrivals) using stateManager
---

## 2026-02-14 - US-022
- What was implemented: Added world image generation with NPCs present
- Files changed:
  - src/imageService.ts (modified - added NPC-aware image generation functions)
- **Learnings for future iterations:**
  - `generateWorldImage(worldState, locationId)` is the main entry point for world system image generation
  - Returns `{ imageUrl: string, stateHash: string }` - stateHash can be stored in location.imageStateHash
  - `generateImageStateHash(location, presentNpcs)` creates a 12-char SHA256 hash from location+NPC state
  - Hash includes: locationId, description, imagePrompt, and sorted array of alive NPC (id, name, physicalDescription)
  - `buildImagePromptWithNpcs(location, presentNpcs)` combines location.imagePrompt with NPC physical descriptions
  - NPC descriptions appended as: ". Characters present: [npc1 physicalDescription]; [npc2 physicalDescription]"
  - Cache files now named `locationId_stateHash.png` for proper invalidation
  - Backwards compatible: getCachedImage() falls back to old-style `locationId.png` if no hash match
  - Type predicate `(npc): npc is NPC =>` used to filter undefined NPCs from map results
  - Pre-existing type error in imageService.ts on `response.data[0]?.url` - this is documented and ignored
---

## 2026-02-14 - US-023
- What was implemented: Added background image pre-generation for movement destinations
- Files changed:
  - src/imageService.ts (modified - added preGenerateImagesForDestinations function)
  - index.ts (modified - integrated pre-generation into 4 locations that return suggested actions)
- **Learnings for future iterations:**
  - `preGenerateImagesForDestinations(worldState, suggestedActions)` is a non-blocking void function
  - Extracts movement destinations from actions with `type: "move"` or `type: "travel"` and `targetLocationId`
  - Uses Set to deduplicate destination IDs, then converts to Array with `Array.from()` for iteration (avoids TS2802 error)
  - Checks cache first with `getCachedImage()` before generating - avoids unnecessary API calls
  - Uses fire-and-forget pattern: `generateImage(...).then(...).catch(...)` without await
  - Console logs provide visibility: "üñºÔ∏è Pre-generating...", "‚úÖ Pre-generated...", "‚ùå Pre-generation failed..."
  - Integrated at 4 points in index.ts: GET /api/world/state, POST /api/world/action, POST /api/world/freeform (both rejection and success paths)
  - Pre-generation happens AFTER response is prepared but BEFORE it's returned - truly non-blocking
---

## 2026-02-14 - US-024
- What was implemented: Created canvas map data structure function for rendering explored areas
- Files changed:
  - src/world/mapService.ts (created)
- **Learnings for future iterations:**
  - `getMapData(worldState)` returns `MapLocation[]` with id, name, x, y, terrain, isCurrent
  - MapLocation interface exported for use by API endpoint and frontend
  - Function filters locations to only those in `player.knowledge.locations`
  - Current location is always included even if not in knowledge (edge case safety)
  - Handles both location IDs and location names in knowledge array (via fallback lookup)
  - Deduplicates results in case both ID and name match the same location
  - No new type errors introduced - verified with `bun run tsc --noEmit --skipLibCheck`
---

## 2026-02-14 - US-025
- What was implemented: Added GET /api/world/map endpoint for canvas map rendering
- Files changed:
  - index.ts (modified - added /api/world/map endpoint and getMapData import)
- **Learnings for future iterations:**
  - Simple endpoint: imports `getMapData` from mapService, calls it with worldState, returns JSON array
  - Returns exactly `{ id, name, x, y, terrain, isCurrent }` for each visited location
  - No parameters needed - worldState is module-level variable
  - The endpoint is synchronous (no async needed) since getMapData does no I/O
---

## 2026-02-14 - US-026
- What was implemented: Created permadeath handler for player death with world persistence
- Files changed:
  - src/world/stateManager.ts (modified - added handlePlayerDeath function)
- **Learnings for future iterations:**
  - `handlePlayerDeath(worldState, deathDescription)` is an exported function (not a state change handler, but direct call)
  - Creates `DeceasedHero` record with: id, name, physicalDescription, origin, diedAtAction, deathDescription, deathLocationId, majorDeeds, itemsLeftBehind, knownByNpcIds
  - Major deeds are gathered from significant events (combat, quest, discovery, relationship types), limited to last 10
  - `knownByNpcIds` includes NPCs who had conversations, knew player's name, or were companions
  - Player's inventory items are added to the death location's items array (truly left behind)
  - Companions are marked as `isCompanion: false` (scattered) but stay alive at their current location
  - A death event is added to eventHistory with type "death" and isSignificant: true
  - Fresh player state resets to: loc_village_square, 100 HP, level 1, empty inventory, minimal knowledge, zero behavior patterns
  - Fresh player retains structure but with undefined name and empty backstory (ready for new character creation)
---

## 2026-02-14 - US-027
- What was implemented: Created new character generator for creating a character after death
- Files changed:
  - src/world/gptService.ts (modified - added generateNewCharacter function, NEW_CHARACTER_SCHEMA, GeneratedCharacterData and NewCharacterResult interfaces)
- **Learnings for future iterations:**
  - `generateNewCharacter(worldState, backstoryInput)` returns `NewCharacterResult` with: player (Player object), narrative (starting narrative), npcUpdates (array of NPC knowledge updates)
  - GPT generates: name, physicalDescription, origin, hiddenBackstory, startingNarrative, knownLore, connectionToFallenHeroes
  - New character starts with fresh stats (100 HP, level 1, 25 gold starting gold), empty inventory, and minimal knowledge (village locations only)
  - Function looks up deceasedHeroes from worldState to create potential connections (new character might be related to fallen heroes)
  - NPCs who knew fallen heroes (`hero.knownByNpcIds`) can receive knowledge updates about the new character's connection
  - Starting location defaults to loc_millbrook_square or loc_village_square, whichever exists
  - `hiddenBackstory` is meant to be revealed through flashbacks, not immediately visible
  - Returns `npcUpdates` array that the caller should apply to update NPC knowledge about new hero's connections to fallen heroes
  - Import `Player` type from types.ts since we're returning a Player object
---

## 2026-02-14 - US-028
- What was implemented: Added POST /api/world/new-character endpoint for creating a new character after death
- Files changed:
  - index.ts (modified - added /api/world/new-character endpoint and generateNewCharacter import)
- **Learnings for future iterations:**
  - `/api/world/new-character` accepts `{ backstory: string }` in body
  - Endpoint calls `generateNewCharacter(worldState, backstory)` and applies the result
  - NPC `knowledge` is a `string[]` (not an object with `.lore`) - add knowledge items directly to the array
  - New player object is applied directly: `worldState = { ...worldState, player: result.player }`
  - NPC knowledge updates are applied via for-loop filtering duplicates with `.includes()`
  - Returns: player summary (name, physicalDescription, origin, health, gold, level), narrative, startingLocation
  - Starting location object contains: id, name, description, terrain (or null if not found)
---

## 2026-02-14 - US-029
- What was implemented: Created quest tracking handlers for adding and updating quests
- Files changed:
  - src/world/stateManager.ts (modified - added handleAddQuest and handleUpdateQuest handlers)
  - src/world/types.ts (modified - added "update_quest" to StateChange type union)
- **Learnings for future iterations:**
  - `add_quest` handler accepts either a full Quest object OR individual fields (title, description, giverNpcId, objectives, rewards)
  - Quest IDs are auto-generated in format: `quest_{timestamp}_{randomSuffix}`
  - Quests start with status "active" and empty completedObjectives array
  - `update_quest` handler supports partial updates: can update status alone, completedObjectives alone, or both
  - Auto-completion: when all objectives are marked complete, quest status automatically changes to "completed"
  - Duplicate quest IDs are rejected (returns state unchanged with warning)
  - Duplicate objective completions are ignored (idempotent)
  - Quest type already existed in types.ts with: id, title, description, giverNpcId, status, objectives, completedObjectives, rewards
---

