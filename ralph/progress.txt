# Ralph Progress Log
# Feature: Text-to-Speech Narration & UI Reorganization
# Branch: ralph/text-to-speech
# Started: 2026-02-15

## Codebase Patterns
- Pre-existing type errors exist in index.ts, App.tsx, gameEngine.ts, imageService.ts - don't need to fix these for new features
- GPT prompts are in src/world/gptService.ts
- Frontend components in src/frontend/ with worldStyles.css for styling
- World system uses /api/world/* endpoints with worldState.locations
- NPC data stored in worldState.npcs with persistence to world-state.json
- BackgroundMusic component already exists in src/frontend/BackgroundMusic.tsx
- StoryPanel parses narrative text to extract NPC dialogue using regex pattern
- TTS service in src/world/ttsService.ts - use generateSpeech(text, voice, instructions?) for audio generation

---

## 2026-02-15 - US-001: Create TTS Service
- Implemented generateSpeech function in src/world/ttsService.ts
- Uses OpenAI's gpt-4o-mini-tts model for high-quality TTS with personality instructions
- Supports all 11 voices: alloy, ash, ballad, coral, echo, fable, onyx, nova, sage, shimmer, verse
- Includes NARRATOR_VOICE (fable) and NARRATOR_INSTRUCTIONS constants for US-009
- NPC_VOICE_POOL excludes fable to reserve it for narrator
- Returns ArrayBuffer (mp3 format) on success, null on failure
- Graceful error handling with logging
- Files changed: src/world/ttsService.ts (created)
- **Learnings for future iterations:**
  - OpenAI audio.speech.create returns a Response object, use .arrayBuffer() to get raw audio
  - Instructions parameter only works with gpt-4o-mini-tts model (not tts-1 or tts-1-hd)
  - API limit is 4096 characters per request
---

## 2026-02-15 - US-002: Create TTS API Endpoint
- Created POST /api/tts endpoint in index.ts
- Accepts JSON body with text, voice, and optional instructions
- Validates required fields (text, voice) with 400 error for missing
- Validates voice is one of the 11 allowed TTS voices
- Enforces 4096 character limit with 400 error if exceeded
- Returns audio/mpeg response with Content-Type and Content-Length headers
- Returns 500 for API failures (generateSpeech returns null)
- Wraps entire handler in try/catch for graceful error handling
- Files changed: index.ts (added import, added /api/tts route)
- **Learnings for future iterations:**
  - Bun.serve routes support POST handlers that return Response objects directly
  - ArrayBuffer can be passed directly to Response constructor for binary data
  - TTSVoice type is exported from ttsService.ts for validation
---

