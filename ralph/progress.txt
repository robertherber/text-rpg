# Ralph Progress Log
# Feature: Text-to-Speech Narration & UI Reorganization
# Branch: ralph/text-to-speech
# Started: 2026-02-15

## Codebase Patterns
- Pre-existing type errors exist in index.ts, App.tsx, gameEngine.ts, imageService.ts - don't need to fix these for new features
- GPT prompts are in src/world/gptService.ts
- Frontend components in src/frontend/ with worldStyles.css for styling
- World system uses /api/world/* endpoints with worldState.locations
- NPC data stored in worldState.npcs with persistence to world-state.json
- BackgroundMusic component already exists in src/frontend/BackgroundMusic.tsx
- StoryPanel parses narrative text to extract NPC dialogue using regex pattern
- TTS service in src/world/ttsService.ts - use generateSpeech(text, voice, instructions?) for audio generation

---

## 2026-02-15 - US-001: Create TTS Service
- Implemented generateSpeech function in src/world/ttsService.ts
- Uses OpenAI's gpt-4o-mini-tts model for high-quality TTS with personality instructions
- Supports all 11 voices: alloy, ash, ballad, coral, echo, fable, onyx, nova, sage, shimmer, verse
- Includes NARRATOR_VOICE (fable) and NARRATOR_INSTRUCTIONS constants for US-009
- NPC_VOICE_POOL excludes fable to reserve it for narrator
- Returns ArrayBuffer (mp3 format) on success, null on failure
- Graceful error handling with logging
- Files changed: src/world/ttsService.ts (created)
- **Learnings for future iterations:**
  - OpenAI audio.speech.create returns a Response object, use .arrayBuffer() to get raw audio
  - Instructions parameter only works with gpt-4o-mini-tts model (not tts-1 or tts-1-hd)
  - API limit is 4096 characters per request
---

## 2026-02-15 - US-002: Create TTS API Endpoint
- Created POST /api/tts endpoint in index.ts
- Accepts JSON body with text, voice, and optional instructions
- Validates required fields (text, voice) with 400 error for missing
- Validates voice is one of the 11 allowed TTS voices
- Enforces 4096 character limit with 400 error if exceeded
- Returns audio/mpeg response with Content-Type and Content-Length headers
- Returns 500 for API failures (generateSpeech returns null)
- Wraps entire handler in try/catch for graceful error handling
- Files changed: index.ts (added import, added /api/tts route)
- **Learnings for future iterations:**
  - Bun.serve routes support POST handlers that return Response objects directly
  - ArrayBuffer can be passed directly to Response constructor for binary data
  - TTSVoice type is exported from ttsService.ts for validation
---

## 2026-02-15 - US-003: Add Voice Field to NPC Data
- Added optional `voice` field to NPC interface in src/world/types.ts
- Created `assignNpcVoice()` function in ttsService.ts that randomly selects from NPC_VOICE_POOL
- Voice pool excludes fable (reserved for narrator): alloy, ash, ballad, coral, echo, onyx, nova, sage, shimmer, verse
- Updated /api/world/talk handler in index.ts to assign voice when conversation starts if NPC lacks one
- Updated streaming conversation handler to also assign voice if needed
- Voice is persisted automatically via worldState save
- Files changed: src/world/types.ts, src/world/ttsService.ts, index.ts
- **Learnings for future iterations:**
  - NPC state is updated in index.ts API handlers, not in gptService.ts functions
  - Voice assignment uses nullish coalescing (??), so existing voices are preserved
  - TypeScript strict mode requires type assertion for array indexing (used `as TTSVoice`)
---

## 2026-02-15 - US-004: Move Actions Panel Below Story
- Moved ActionPanel from right column (actions-panel section) to story tab content area
- ActionPanel now renders below StoryPanel inside a React fragment when story tab is active
- ActionPanel only visible when Story tab is active
- Present NPCs section and InventoryPanel remain in right column
- Added CSS for .content-panel .actions-section to style the action panel when in content area
- Files changed: src/frontend/WorldApp.tsx, src/frontend/worldStyles.css
- **Learnings for future iterations:**
  - Use React fragment (<>...</>) to group multiple components in conditional rendering
  - Content-panel child styling can be targeted with .content-panel .child-class selector
  - No dev-browser skill available - manual browser verification needed for UI changes
---

## 2026-02-15 - US-005: Add Inventory Tab
- Added Inventory tab button to panel-tabs in WorldApp.tsx
- Tab order is now: Story | Map | Journal | Inventory
- Updated activePanel state type to include 'inventory'
- InventoryPanel now renders in content area when Inventory tab is active
- Removed InventoryPanel from right column (actions-panel section)
- Right column now only shows Present NPCs section
- Files changed: src/frontend/WorldApp.tsx
- **Learnings for future iterations:**
  - Tabs use same activePanel state pattern, just extend the union type
  - Components can be moved between layout sections by changing their parent JSX element
  - No dev-browser skill available - manual browser verification needed for UI changes
---

## 2026-02-15 - US-006: Simplify Right Column Layout
- Added `hasNpcs` variable to conditionally render the right column
- Right column only renders when `worldState.presentNpcs.length > 0`
- Added `no-right-column` class to `world-main` when no NPCs present
- CSS grid changes from `400px 1fr 350px` to `400px 1fr` when no right column
- Removed border-right on content-panel when right column is hidden
- Updated responsive breakpoints for 1200px and 900px to handle no-right-column state
- Files changed: src/frontend/WorldApp.tsx, src/frontend/worldStyles.css
- **Learnings for future iterations:**
  - Use CSS class toggling with conditional rendering for layout changes
  - Grid template columns can be overridden with modifier classes
  - Keep responsive styles in sync with layout modifier classes
---

## 2026-02-15 - US-007: Create Narration Audio Context
- Created NarrationContext.tsx with NarrationProvider and useNarration hook
- Context provides: isPlaying, currentText, playNarration(text, voice, instructions?), skipCurrent(), setMusicVolume callback
- Implements audio queue for narration requests (plays in order they arrive)
- Fetches audio from /api/tts endpoint and plays via HTMLAudioElement
- Handles playback errors gracefully, cleans up object URLs
- Music volume ducking coordination via setMusicVolume callback (0.2 during playback, 1.0 after)
- Wrapped WorldApp with NarrationProvider in public/worldMain.tsx
- Files changed: src/frontend/NarrationContext.tsx (created), public/worldMain.tsx
- **Learnings for future iterations:**
  - Use ref for queue to avoid stale closures in async callbacks
  - Check for undefined after array index access when using strict TypeScript
  - URL.revokeObjectURL should be called when audio is done playing or skipped
---

## 2026-02-15 - US-008: Create Audio Playback Component
- Created NarrationPlayer.tsx UI component for narration controls
- Component uses useNarration hook to access isPlaying, currentText, skipCurrent
- Shows skip button with speaker icon when audio is playing
- Skip button calls skipCurrent() to stop current audio and move to next in queue
- Component returns null when no audio is playing (doesn't render)
- Added CSS styles with animation for smooth slide-up entrance
- Added NarrationPlayer to WorldApp.tsx below BackgroundMusic component
- Files changed: src/frontend/NarrationPlayer.tsx (created), src/frontend/WorldApp.tsx, src/frontend/worldStyles.css
- **Learnings for future iterations:**
  - NarrationContext already handles all playback logic (fetching, queueing, cleanup)
  - NarrationPlayer is purely a UI component that displays controls
  - Fixed positioning with transform translateX(-50%) centers component horizontally
  - No dev-browser skill available - manual browser verification needed for UI changes
---

## 2026-02-15 - US-009: Integrate Narrator Voice with Personality
- Verified that NARRATOR_VOICE and NARRATOR_INSTRUCTIONS were already added in US-001
- NARRATOR_VOICE is 'fable' - reserved for narrator only
- NARRATOR_INSTRUCTIONS contains chaotic trickster personality guidance
- Both constants are properly exported from ttsService.ts for frontend use
- No code changes needed - story was proactively implemented during US-001
- Files unchanged (already complete): src/world/ttsService.ts
- **Learnings for future iterations:**
  - Check existing code before implementing - features may be proactively added
  - ttsService.ts exports NARRATOR_VOICE, NARRATOR_INSTRUCTIONS, and NPC_VOICE_POOL for frontend use
---

## 2026-02-15 - US-010: Auto-play Narrator Text
- Created useAutoNarration hook in src/frontend/useAutoNarration.ts
- Hook watches storyMessages for new narrative messages
- Only plays for type: "narrative" messages (ignores action/system)
- Parses narrative text using exported parseNarrativeText from StoryPanel
- Plays narrator segments using NARRATOR_VOICE with NARRATOR_INSTRUCTIONS
- Dialog segments are skipped (handled by US-011)
- Handles streaming messages by waiting for completion before playing
- Exported parseNarrativeText and TextSegment from StoryPanel for reuse
- Added speakerName field to TextSegment for future NPC voice support
- Integrated hook in WorldApp with useAutoNarration(storyMessages, streamingMessageId)
- Files changed: src/frontend/StoryPanel.tsx, src/frontend/WorldApp.tsx, src/frontend/useAutoNarration.ts (created)
- **Learnings for future iterations:**
  - Use refs for tracking processed IDs to avoid stale closure issues
  - parseNarrativeText is exported from StoryPanel.tsx for TTS parsing
  - TextSegment has speakerName field for NPC dialog (used in US-011)
  - streamingMessageId indicates a message still receiving content - wait before TTS
---

## 2026-02-15 - US-011: Auto-play NPC Dialogue
- Extended useAutoNarration hook to play NPC dialogue with distinct voices
- Added third parameter `presentNpcs` to useAutoNarration for voice lookup
- Renamed playNarratorProse to playNarrativeSegments - now plays ALL segments in order
- Created getNpcVoice function to look up NPC voice by name (case-insensitive partial match)
- Uses FALLBACK_NPC_VOICE ('alloy') when NPC not found or has no voice assigned
- NPC dialogue plays without personality instructions (natural voice)
- Added voice field to presentNpcs in /api/world/state API response
- Updated NPC interface in WorldApp.tsx to include optional voice field
- Updated WorldApp to pass worldState?.presentNpcs to useAutoNarration
- Files changed: index.ts, src/frontend/WorldApp.tsx, src/frontend/useAutoNarration.ts
- **Learnings for future iterations:**
  - Use refs for presentNpcs to get latest value in async callbacks
  - NPC name matching is case-insensitive and supports partial matches
  - isValidTTSVoice helper validates voice strings before casting to TTSVoice
  - No dev-browser skill available - manual browser verification needed for UI changes
---

