{
  "project": "Dragon's Bane - Open World Text RPG",
  "branchName": "ralph/dialog-map-improvements",
  "description": "Dialog & Map UI Improvements - Better dialog presentation, immersive hand-drawn map, and streaming responses",
  "userStories": [
    {
      "id": "US-001",
      "title": "De-emphasize narrator text styling",
      "description": "As a player, I want narrator text to be visually distinct from NPC dialog so I can easily tell who is speaking.",
      "acceptanceCriteria": [
        "Narrator text renders in italic style",
        "Narrator text uses muted gray color (#6b7280 or similar)",
        "NPC dialog remains in normal weight with standard text color",
        "Clear visual distinction between narrator descriptions and NPC speech",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented text parsing to segment narrator vs dialog, styled with CSS"
    },
    {
      "id": "US-002",
      "title": "Update player reference terminology in prompts",
      "description": "As a player, I want NPCs to address me as 'adventurer' or similar terms so the game feels more immersive.",
      "acceptanceCriteria": [
        "GPT prompts instruct NPCs to use 'adventurer', 'traveler', 'stranger', 'hero' etc.",
        "Never use the word 'player' in NPC dialog or narrator text",
        "Update conversation system prompt in gptService.ts",
        "Update action resolution system prompt in gptService.ts",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Updated all GPT prompts to use 'adventurer' instead of 'player', added explicit instructions to never use 'player'"
    },
    {
      "id": "US-003",
      "title": "Prevent narrator from repeating NPC dialog",
      "description": "As a player, I want the narrator to describe NPC behavior without echoing their words so dialog isn't redundant.",
      "acceptanceCriteria": [
        "Narrator describes actions, expressions, tone - not speech content",
        "NPC dialog appears exactly once in quotes",
        "System prompts explicitly forbid narrator from paraphrasing NPC speech",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added explicit DIALOG RULES to NARRATOR_PERSONALITY, strengthened action resolution and conversation prompts with CRITICAL rule and WRONG/CORRECT examples"
    },
    {
      "id": "US-004",
      "title": "Shorten dialog and narration lengths",
      "description": "As a player, I want NPC responses and narrator descriptions to be concise so the game feels snappy.",
      "acceptanceCriteria": [
        "NPC responses limited to 1-2 sentences typically",
        "Narrator descriptions limited to 1 sentence",
        "Action narratives limited to 2-3 sentences",
        "GPT prompts specify 'be concise' and include max length guidance",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added BREVITY RULES to NARRATOR_PERSONALITY, updated action resolution RULES, conversation RULES, and schema descriptions to enforce 2-3 sentence action narratives, 1-2 sentence NPC responses, and 1 sentence narrator frames"
    },
    {
      "id": "US-005",
      "title": "Generate dialog response suggestions",
      "description": "As a player, I want 3 suggested dialog responses when talking to NPCs so I have conversation options.",
      "acceptanceCriteria": [
        "handleConversation returns suggestedResponses array with 3 items",
        "Suggestions include 2 contextual + 1 generic option",
        "Each suggestion has id, text, and type field",
        "Suggestions show tone in brackets like '[Friendly] How's business?'",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added SuggestedResponse interface and type, updated CONVERSATION_RESPONSE_SCHEMA with suggestedResponses array, updated handleConversation prompt with SUGGESTED RESPONSES rules and return value"
    },
    {
      "id": "US-006",
      "title": "Display dialog suggestions in conversation UI",
      "description": "As a player, I want to see and click dialog suggestions during conversations.",
      "acceptanceCriteria": [
        "ActionPanel shows suggested responses as clickable buttons in conversation mode",
        "Clicking a suggestion sends that message to the NPC",
        "Suggestions appear below the conversation input",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added SuggestedResponse interface, updated conversationState to include suggestions, passed from API to WorldApp to ActionPanel, styled with contextual/generic variants"
    },
    {
      "id": "US-007",
      "title": "Add GPT retry logic with exponential backoff",
      "description": "As a player, I want the game to recover gracefully from GPT failures.",
      "acceptanceCriteria": [
        "GPT calls retry up to 2 times on JSON parse failure",
        "Exponential backoff between retries (500ms, 1500ms)",
        "After retries exhausted, throw error with message for UI handling",
        "Log failures for debugging (console)",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented retry logic with MAX_RETRIES=2, RETRY_DELAYS=[500,1500], refactored callGPT to use makeGPTCall helper"
    },
    {
      "id": "US-008",
      "title": "Add error handling UI for failed requests",
      "description": "As a player, I want to see a friendly error message with retry option when things fail.",
      "acceptanceCriteria": [
        "Error state shows 'Something went wrong. Retry?' message",
        "Error message has 'Try again' button",
        "Clicking retry re-attempts the last action",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Added actionError and lastAction state to WorldApp, LastAction union type tracks last action type for retry, StoryPanel displays error with retry button, styled error message in worldStyles.css"
    },
    {
      "id": "US-009",
      "title": "Add thematic loading indicators",
      "description": "As a player, I want loading feedback that fits the game's tone.",
      "acceptanceCriteria": [
        "Loading shows pulsing/fading text inline under the last message",
        "Multiple thematic variations rotate randomly: 'The narrator ponders...', 'Fate weaves its thread...', 'The story unfolds...', 'A moment of contemplation...'",
        "Loading indicator appears for area navigation, dialog, and actions",
        "Action/dialog buttons disabled during loading",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Added LoadingIndicator component with 8 thematic variations, pulsing CSS animation, isLoading prop passed to StoryPanel"
    },
    {
      "id": "US-010",
      "title": "Fix image loading issues",
      "description": "As a player, I want location images to load correctly instead of showing placeholder text.",
      "acceptanceCriteria": [
        "Debug why images show 'village' placeholder instead of generated images",
        "Verify DALL-E API calls are succeeding",
        "Verify image URLs are being stored and retrieved correctly",
        "Images display when available",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Root cause: /api/game/image/:id used static gameData locations instead of worldState.locations. Fixed by adding /api/world/image/:id endpoint that uses generateWorldImage with dynamic world state"
    },
    {
      "id": "US-011",
      "title": "Add image loading states with parchment placeholder",
      "description": "As a player, I want to see loading indicators for images.",
      "acceptanceCriteria": [
        "Parchment texture placeholder with 'Revealing...' text while image generates",
        "Error state with retry button if image fails to load",
        "Graceful fallback if image unavailable (styled placeholder, not broken image)",
        "Loading state doesn't block other UI interactions",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Added parchment-textured loading state with thematic messages (Revealing, The scene unfolds, etc.), error state with retry button, and graceful fallback placeholder with terrain icons"
    },
    {
      "id": "US-012",
      "title": "Create parchment map background texture",
      "description": "As a player, I want the map to have a parchment/aged paper background.",
      "acceptanceCriteria": [
        "Map canvas renders parchment texture as background",
        "Map edges have subtle worn/torn parchment effect",
        "Background fits the medieval fantasy theme",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add hand-drawn terrain icons to map",
      "description": "As a player, I want terrain rendered with hand-drawn style icons.",
      "acceptanceCriteria": [
        "Map uses terrain-appropriate hand-drawn icons based on location terrain type",
        "Location markers look hand-drawn (not generic pins)",
        "Player position clearly marked with distinctive icon",
        "Icons fit the fantasy parchment aesthetic",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add fog of war to map",
      "description": "As a player, I want unexplored areas hidden by fog so discovery feels rewarding.",
      "acceptanceCriteria": [
        "Unexplored map tiles/areas covered with fog or cloud effect",
        "Fog clears for visited tile + immediate neighbors (1 tile radius)",
        "Explored areas remain visible permanently",
        "Fog has soft edges that blend naturally",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Add streaming GPT responses to backend",
      "description": "As a developer, I need the backend to support streaming narrative responses.",
      "acceptanceCriteria": [
        "Add streaming endpoint that uses OpenAI stream: true option",
        "Endpoint streams narrative text via SSE or chunked transfer",
        "Structured data (suggested actions, state changes) returned separately after stream",
        "Streaming works for both action narratives and conversation responses",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Add streaming response support to frontend",
      "description": "As a player, I want narrative text to stream in progressively.",
      "acceptanceCriteria": [
        "StoryPanel renders streamed text progressively as tokens arrive",
        "Use EventSource or fetch streaming on frontend",
        "UI remains responsive during streaming",
        "Final state (suggested actions) applied after stream completes",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    }
  ]
}
