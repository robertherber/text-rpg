{
  "project": "Dragon's Bane - Open World Text RPG",
  "branchName": "ralph/text-to-speech",
  "description": "Text-to-Speech Narration & UI Reorganization - Immersive audio narration with persistent NPC voices, plus UI layout improvements",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create TTS Service",
      "description": "As a developer, I need a service to call OpenAI's speech API so that text can be converted to audio.",
      "acceptanceCriteria": [
        "Create src/world/ttsService.ts with function generateSpeech(text: string, voice: string, instructions?: string): Promise<ArrayBuffer | null>",
        "Use model gpt-4o-mini-tts",
        "Support voice parameter from available voices: alloy, ash, ballad, coral, echo, fable, onyx, nova, sage, shimmer, verse",
        "Support optional instructions parameter for narrator personality",
        "Return audio as ArrayBuffer (mp3 format)",
        "Handle errors gracefully (return null on failure, log error, don't crash)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create TTS API Endpoint",
      "description": "As a developer, I need a backend endpoint to generate speech audio so the frontend can request narration.",
      "acceptanceCriteria": [
        "Create POST /api/tts endpoint in index.ts",
        "Accept JSON body: { text: string, voice: string, instructions?: string }",
        "Return audio/mpeg response with generated speech",
        "Limit text to 4096 characters (API limit) - return 400 if exceeded",
        "Return 400 for missing required fields (text, voice)",
        "Return 500 for API failures",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add Voice Field to NPC Data",
      "description": "As a developer, I need to store NPC voice assignments so they remain consistent across sessions.",
      "acceptanceCriteria": [
        "Add optional voice field to NPC interface in worldState.ts",
        "Create assignNpcVoice function that randomly selects from voice pool (excluding fable which is narrator)",
        "Voice pool: alloy, ash, ballad, coral, echo, onyx, nova, sage, shimmer, verse",
        "When conversation starts with NPC lacking voice, assign and persist to world-state.json",
        "Update handleConversation/handleConversationStreaming to call assignNpcVoice if needed",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Move Actions Panel Below Story",
      "description": "As a user, I want the actions panel below the story so I can see more story content and have a natural reading flow.",
      "acceptanceCriteria": [
        "Remove ActionPanel from right column (actions-panel section) in WorldApp.tsx",
        "Place ActionPanel inside story tab content area, below StoryPanel",
        "ActionPanel only visible when Story tab is active",
        "Present NPCs section remains in right column",
        "Update CSS layout in worldStyles.css accordingly",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Add Inventory Tab",
      "description": "As a user, I want Inventory as its own tab so I can access it without scrolling the actions panel.",
      "acceptanceCriteria": [
        "Add Inventory tab button to panel-tabs in WorldApp.tsx",
        "Tab order: Story | Map | Journal | Inventory",
        "Update activePanel state type to include 'inventory'",
        "When Inventory tab active, show InventoryPanel in content area",
        "Remove InventoryPanel from right column (actions-panel section)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Simplify Right Column Layout",
      "description": "As a developer, I need to simplify the right column now that Actions and Inventory have moved.",
      "acceptanceCriteria": [
        "Right column contains only Present NPCs section",
        "Hide right column entirely if no NPCs present (use conditional rendering)",
        "Adjust CSS grid to give more space to content panel when right column hidden",
        "Maintain responsive behavior on smaller screens",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create Narration Audio Context",
      "description": "As a developer, I need a React context to coordinate audio playback and music ducking.",
      "acceptanceCriteria": [
        "Create src/frontend/NarrationContext.tsx with NarrationProvider and useNarration hook",
        "Context provides: isPlaying, currentText, playNarration(text, voice, instructions?), skipCurrent(), setMusicVolume callback",
        "Wrap WorldApp with NarrationProvider",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create Audio Playback Component",
      "description": "As a user, I want narrative text to be read aloud automatically so I can enjoy an immersive audio experience.",
      "acceptanceCriteria": [
        "Create src/frontend/NarrationPlayer.tsx component",
        "Component listens to NarrationContext for playNarration calls",
        "Fetches audio from /api/tts endpoint",
        "Uses HTMLAudioElement for playback",
        "Queues messages if they arrive faster than playback",
        "Shows skip button while audio is playing",
        "Skip button stops current audio and moves to next in queue",
        "Handles playback errors gracefully (log error, continue to next message)",
        "Properly cleans up URLs with URL.revokeObjectURL on unmount",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Integrate Narrator Voice with Personality",
      "description": "As a user, I want the narrator to sound like a chaotic trickster so the audio matches the written personality.",
      "acceptanceCriteria": [
        "Define NARRATOR_VOICE constant as 'fable' in ttsService.ts",
        "Define NARRATOR_INSTRUCTIONS constant with chaotic trickster personality guidance",
        "Instructions text: 'Speak with playful, mischievous energy. You are a chaotic trickster narrator - witty, theatrical, occasionally breaking the fourth wall. Vary your pacing for dramatic effect.'",
        "Export both constants for use by frontend",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Auto-play Narrator Text",
      "description": "As a user, I want narrator descriptions to play automatically when they appear.",
      "acceptanceCriteria": [
        "When new narrative message added to StoryPanel, trigger narration via NarrationContext",
        "Parse narrative text to separate narrator prose from NPC dialogue",
        "Narrator prose uses NARRATOR_VOICE with NARRATOR_INSTRUCTIONS",
        "Only play for narrative type messages (not action or system)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Auto-play NPC Dialogue",
      "description": "As a user, I want each NPC to have their own distinct voice so I can identify who is speaking.",
      "acceptanceCriteria": [
        "Parse narrative text to identify NPC dialogue (format: Name: 'dialogue' or standalone 'dialogue')",
        "For named NPC dialogue, fetch NPC voice from /api/world/state presentNpcs list",
        "If NPC not in presentNpcs or no voice, use a fallback voice (alloy)",
        "Play NPC dialogue with their assigned voice (no personality instructions)",
        "Queue narrator and NPC audio in order they appear in text",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Duck Background Music During Speech",
      "description": "As a user, I want the background music to lower during narration so I can hear the speech clearly.",
      "acceptanceCriteria": [
        "Update BackgroundMusic component to accept onVolumeControl callback prop",
        "NarrationContext calls onVolumeControl when audio starts/stops",
        "When TTS audio starts playing, reduce background music volume to 20% of current level",
        "When TTS audio ends (or is skipped), restore background music to previous volume",
        "Transition smoothly using gain node or volume fade over 300ms",
        "Handle rapid start/stop without glitches",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    }
  ]
}
